name: Deploy to Amazon EC2 

on:
  push:
    branches: [ "main" ]
    
permissions:
  contents: read

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Create .env file
      run: echo "${{secrets.ENV_PROD}}" > .env
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-2

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1
      
#    - name: Build, tag, and push image to Amazon ECR
#      id: build-image
#      env:
#        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
#        ECR_REPOSITORY: epowe
#        IMAGE_TAG: ${{ github.sha }}
#      run: |
#        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
#        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
#        echo "::set-output name=image::$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
        
    - name: Delete and deploy docker image
      uses: appleboy/ssh-action@master
      env: 
        IMAGE_NAME: 960377929570.dkr.ecr.ap-northeast-2.amazonaws.com/epowe:e19c67458cd9e8f358759cbb9056b380477d3801
        AWS_ACCOUNT_ID : ${{ secrets.AWS_ACCOUNT_ID }}
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PEM_KEY }}
        script: |
          #docker stop $(docker ps -a -q)
          #docker rm $(docker ps -a -q)
          #docker login
          docker login 960377929570.dkr.ecr.ap-northeast-2.amazonaws.com
          #aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID
          docker pull 960377929570.dkr.ecr.ap-northeast-2.amazonaws.com/epowe:e19c67458cd9e8f358759cbb9056b380477d3801
          docker run -d -p 5000:5000 $IMAGE_NAME
          docker image prune
